function flatPromise(e){let t,n;const i=new Promise(((e,i)=>{t=e,n=i}));return e&&e(t,n),{promise:i,resolve:t,reject:n}}function stringHasPrefix(e,t){return 0===e.lastIndexOf(t,0)}var originRegex=/^((?:\w+:)?\/\/([^\/]+))/;function encodeQuery(e){let t=[];const n=Object.keys(e),i=encodeURIComponent;for(let r=0;r<n.length;r++)t.push(`${i(n[r])}=${i(e[n[r]])}`);return t.join("&")}function originOf(e){const t=document.location;if(stringHasPrefix(e,"/")||stringHasPrefix(e,"."))return t.origin?t.origin:t.protocol+"//"+t.host;const n=e.match(originRegex);if(!n)throw new Error("Invalid URL: "+e);return n[1]}var IFrameCommunicationTarget=class{constructor(e){this.ready=!1,this.buffer=[],this.id=e.id,this.type=e.type,this.element=e.element,this.onReady=e.onReady,this.origin=originOf(e.element.src)}send(e){this.ready?this.element.contentWindow.postMessage(e,this.origin):this.buffer.push(e)}setReady(e){this.onReady(),this.ready=e,this.ready&&this.flush()}flush(){for(let e=0;e<this.buffer.length;e++)this.element.contentWindow.postMessage(this.buffer[e],this.origin);this.buffer=[]}};function isAllowedOrigin(e,t){return"*"===e||t.has(e)}var defaultGetStoreFunc,CommunicationBus=class{constructor(){this.origins=new Set,this.targets={},this.answered=new Set,this.onReceiveRootMessage=()=>{},window.addEventListener("message",(e=>{this.onReceive(e)}))}listen(e){let t=this.onReceiveRootMessage;this.onReceiveRootMessage=n=>{t(n),e(n)}}addOrigin(e){this.origins.add(e)}send(e){if(e.from_id){const t=this.targets[e.from_id];if(!t)return void console.error(`[bus] Unexpected message from unknown sender ${e.from_id}`,e);"widget_announce"!==e.type&&"agent_announce"!==e.type||t.setReady(!0)}const t=e.rid;if(t){if(this.answered.has(t+e.to_id))return;this.answered.add(t+e.to_id)}if(""===e.to_id)return void this.onReceiveRootMessage(e);const n=this.targets[e.to_id];n?n.send(e):console.error(`[bus] Unexpected message to unknown target ${e.to_id}`,e)}onReceive(e){if(!isAllowedOrigin(e.origin,this.origins))return;const t=e.data;t&&t._frc&&this.send(t)}registerTarget(e){this.targets[e.id]=e}registerTargetIFrame(e,t,n,i){const r=flatPromise();let s=new Promise((e=>setTimeout((()=>e("timeout")),i)));const o=new IFrameCommunicationTarget({id:t,element:n,type:e,onReady:()=>r.resolve("registered")});return this.registerTarget(o),Promise.race([r.promise,s])}removeTarget(e){delete this.targets[e]}};function randomId(e,t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789"){let n="";for(let i=0;i<e;i++)n+=t.charAt(Math.floor(Math.random()*t.length));return n}function promisifyRequest(e){return new Promise(((t,n)=>{e.oncomplete=e.onsuccess=()=>t(e.result),e.onabort=e.onerror=()=>n(e.error)}))}function createStore(e,t){const n=indexedDB.open(e);n.onupgradeneeded=()=>n.result.createObjectStore(t);const i=promisifyRequest(n);return(e,n)=>i.then((i=>n(i.transaction(t,e).objectStore(t))))}function defaultGetStore(){return defaultGetStoreFunc||(defaultGetStoreFunc=createStore("keyval-store","keyval")),defaultGetStoreFunc}function get(e,t=defaultGetStore()){return t("readonly",(t=>promisifyRequest(t.get(e))))}function set(e,t,n=defaultGetStore()){return n("readwrite",(n=>(n.put(t,e),promisifyRequest(n.transaction))))}var SESSION_COUNT_KEY="frc_sc",SESSION_ID_KEY="frc_sid",SEPARATOR="__",didIncrease=!1,sc="0",sid="__"+randomId(10);function sessionCount(e){if(!didIncrease){let t=0;try{t=parseInt(sessionStorage.getItem(SESSION_COUNT_KEY)||"",10)}catch(e){}isNaN(t)&&(t=0),e&&t++,sc=t.toString();try{sessionStorage.setItem(SESSION_COUNT_KEY,sc)}catch(e){}}return sc}function sessionId(){let e;try{e=sessionStorage.getItem(SESSION_ID_KEY)}catch(e){return sid}return e||(e=randomId(12),sessionStorage.setItem(SESSION_ID_KEY,e)),e}var Store=class{constructor(e){this.mem=new Map,this.storePrefix=e}setup(){return new Promise(((e,t)=>{if(void 0!==this._hasSA)return e(this._hasSA);try{indexedDB.open("")}catch(t){return e(this._hasSA=!1)}if(!document.hasStorageAccess)return e(this._hasSA=!0);document.hasStorageAccess().then((t=>(this._hasSA=t,this._hasSA?this.idb=createStore("friendlycaptcha","frc"):console.debug("FRC has no storage access"),e(this._hasSA)))).catch(t)}))}get(e,t){return this.setup().then((n=>{const i=this.storePrefix+SEPARATOR+e;if(t.p)return n?get(i,this.idb):this.mem.get(e);try{const e=sessionStorage.getItem(i);return null===e?void 0:e}catch(e){}return this.mem.get(e)}))}set(e,t,n){return this.setup().then((i=>{const r=this.storePrefix+SEPARATOR+e;if(n.p){if(i)return set(r,t,this.idb);void 0===t?this.mem.delete(e):this.mem.set(e,t)}else try{void 0===t?(this.mem.delete(e),sessionStorage.removeItem(r)):(this.mem.set(e,t),sessionStorage.setItem(r,t))}catch(e){}}))}hasSA(){return this._hasSA}},supportAllowClipboardWrite="undefined"!=typeof navigator&&void 0!==navigator.userAgentData;function findCaptchaElements(){return document.querySelectorAll(".frc-captcha")}function findParentFormElement(e){for(;"FORM"!==e.tagName;)if(!(e=e.parentElement))return null;return e}function executeOnceOnFocusInEvent(e,t){e.addEventListener("focusin",t,{once:!0,passive:!0})}function styleIfNotAlreadySet(e,t,n){""===e.style[t]&&(e.style[t]=n)}function setWidgetRootStyles(e){const t=styleIfNotAlreadySet;t(e,"position","relative"),t(e,"height","70px"),t(e,"padding","0"),t(e,"width","316px"),t(e,"maxWidth","100%"),t(e,"maxHeight","100%"),t(e,"overflow","hidden"),t(e,"borderRadius","4px")}function removeWidgetRootStyles(e){e.removeAttribute("style")}function runOnDocumentLoaded(e){"loading"!==document.readyState?e():document.addEventListener("DOMContentLoaded",e)}function fireFRCEvent(e,t){let n;"function"==typeof window.CustomEvent?n=new CustomEvent(t.name,{bubbles:!0,detail:t}):(n=document.createEvent("CustomEvent"),n.initCustomEvent(t.name,!0,!1,t)),e.dispatchEvent(n)}function findFirstParentLangAttribute(e){for(;!e.lang;)if(!(e=e.parentElement))return null;return e.lang}var FRAME_ID_DATASET_FIELD="FrcFrameId",AGENT_FRAME_CLASSNAME="frc-i-agent",WIDGET_FRAME_CLASSNAME="frc-i-widget",WIDGET_PLACEHOLDER_CLASSNAME="frc-widget-placeholder";function createAgentIFrame(e,t,n){const i={origin:document.location.origin,sess_id:sessionId(),sess_c:sessionCount(!0),comm_id:t,sdk_v:"0.1.19",v:"1",agent_id:t,ts:Date.now().toString()},r=document.createElement("iframe");r.className=AGENT_FRAME_CLASSNAME,r.dataset[FRAME_ID_DATASET_FIELD]=t,r.src=n+"?"+encodeQuery(i),r.frcSDK=e;const s=r.style;return s.width=s.height=s.border=s.visibility="0",s.display="none",r}function createWidgetIFrame(e,t,n,i){const r=document.createElement("iframe");let s=i.language;s&&"html"!==s||(s=findFirstParentLangAttribute(i.element)||"");const o={origin:document.location.origin,sess_id:sessionId(),sess_c:sessionCount(!0),comm_id:t,sdk_v:"0.1.19",v:"1",agent_id:e,lang:s,sitekey:i.sitekey||"",ts:Date.now().toString()};i.theme&&(o.theme=i.theme),supportAllowClipboardWrite&&(r.allow="clipboard-write"),r.frameBorder="0",r.src=n+"?"+encodeQuery(o),r.className=WIDGET_FRAME_CLASSNAME,r.dataset[FRAME_ID_DATASET_FIELD]=t;const a=r.style;return a.border=a.visibility="0",a.position="absolute",a.height=a.width="100%",a.display="none",i.element.appendChild(r),r}function createWidgetPlaceholder(e){const t=document.createElement("div");t.classList.add(WIDGET_PLACEHOLDER_CLASSNAME);const n=t.style,i="dark"===e.theme||"auto"===e.theme&&window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches;return n.color=i?"#fff":"#222",n.backgroundColor=i?"#171717":"#fafafa",n.borderRadius="4px",n.border="1px solid",n.borderColor="#ddd",n.padding="8px",n.height=n.width="100%",n.fontSize="14px",setCommonTextStyles(n),e.element.appendChild(t),t}function setCommonTextStyles(e){e.textDecoration=e.fontStyle="none",e.fontWeight="500",e.fontFamily='-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif',e.lineHeight="1",e.letterSpacing="-0.0125rem"}function createBanner(e){const t=document.createElement("div");t.classList.add("frc-banner");const n=t.style;n.position="absolute",n.bottom="2px",n.right="6px",n.lineHeight="1";const i=document.createElement("a");i.href="https://friendlycaptcha.com",i.rel="noopener";const r=i.style;setCommonTextStyles(r),r.fontSize="10px",r.color="#777",r.letterSpacing="-0.0125rem",i.target="_blank",i.textContent="Friendly Captcha",i.onmouseenter=()=>r.textDecoration="underline",i.onmouseleave=()=>r.textDecoration="none",t.appendChild(i),e.element.appendChild(t)}function windowPerformanceNow(){const e=window.performance;return e?e.now():0}function getTrigger(e,t,n,i){const r=windowPerformanceNow(),s=n.getBoundingClientRect(),o={v:1,tt:e,pnow:r,sm:t,el:{bcr:[s.left,s.top,s.width,s.height],con:document.body.contains(n)},stack:(new Error).stack||"",we:!!window.event,weit:!!window.event&&!!window.event.isTrusted};return i&&(o.ev={ts:i.timeStamp,rt:!!i.relatedTarget,eot:!!i.explicitOriginalTarget,it:i.isTrusted}),o}function mergeObject(e,...t){for(let i=0;i<t.length;i++){const r=t[i];for(var n in r)r.hasOwnProperty(n)&&(e[n]=r[n])}return e}var DEFAULT_FORM_FIELD_NAME="frc-captcha-response",WidgetHandle=class{constructor(e){this.state="init",this.response=".UNINITIALIZED",this.focusEventPending=!1,this.isDestroyed=!1,this.id=e.id;const t=e.createOpts;if(this.e=t.element,this.ready=e.registered,!this.e)throw new Error("No element provided to mount widget under.");if(this.e.frcWidget=this,this.formFieldName=void 0===t.formFieldName?DEFAULT_FORM_FIELD_NAME:t.formFieldName,this.sitekey=t.sitekey,this._reset=e.callbacks.onReset,this._destroy=e.callbacks.onDestroy,this._trigger=e.callbacks.onTrigger,this.startMode=e.createOpts.startMode||"focus",null!==this.formFieldName){const e=document.createElement("input");e.type="hidden",e.style.display="none",e.name=this.formFieldName,this.hiddenFormEl=e,this.e.appendChild(e)}this.setState({response:".UNCONNECTED",state:"init"}),this.ready.then((()=>{this.handleStartMode()}))}handleStartMode(){if("focus"!==this.startMode||this.focusEventPending||this.isDestroyed)"auto"===this.startMode&&this.trigger("auto");else{const e=findParentFormElement(this.e);e&&(this.focusEventPending=!0,executeOnceOnFocusInEvent(e,(e=>{this.trigger("focus",{ev:e}),this.focusEventPending=!1})))}}reset(e={trigger:"root"}){if(this.isDestroyed)throw new Error("Can not reset destroyed widget.");this.setState({response:".RESET",state:"reset",resetTrigger:e.trigger}),this._reset(e),this.handleStartMode()}destroy(){this.isDestroyed=!0,this.hiddenFormEl&&this.hiddenFormEl.remove(),this.hiddenFormEl=void 0,this.setState({response:".DESTROYED",state:"destroyed"}),this._destroy()}trigger(e,t={}){if(this.isDestroyed)throw new Error("Can not start destroyed widget.");const n=getTrigger(e,this.startMode,this.e,t.ev);this._trigger({trigger:n})}start(){this.trigger("programmatic")}setState(e){const t=this.state!==e.state;this.response=e.response,this.state=e.state,this.hiddenFormEl&&!1!==this.e.isConnected&&(this.hiddenFormEl.value=e.response),t&&this.dispatchWidgetEvent({name:"frc:widget.statechange",error:e.error}),"expired"===this.state?this.dispatchWidgetEvent({name:"frc:widget.expire"}):"completed"===this.state?this.dispatchWidgetEvent({name:"frc:widget.complete"}):"error"===this.state?this.dispatchWidgetEvent({name:"frc:widget.error",error:e.error}):"reset"===this.state&&this.dispatchWidgetEvent({name:"frc:widget.reset",trigger:e.resetTrigger})}dispatchWidgetEvent(e){const t={response:this.response,state:this.state,id:this.id};mergeObject(t,e),fireFRCEvent(this.e,t)}addEventListener(e,t,n){this.e.addEventListener(e,t,n)}removeEventListener(e,t,n){this.e.removeEventListener(e,t,n)}getState(){return this.state}getResponse(){return this.response}getElement(){return this.e}},isFunc=function(e){return"function"==typeof e},patchNativeFunctions=function(e){const t=[],n=new Map,i=window,r=function(){try{const e=document.createElement("iframe");e.style.display="none",(document.body||document.head).appendChild(e);const t=e?e.contentWindow:0;return e.remove(),t||i}catch(e){return i}}(),s=Function.prototype.toString,o=function(...e){const t=!!isFunc(this)&&n.get(this),i=this===o?s:t||this;return s.apply(i,e)};Function.prototype.toString=o;const a="prototype",c=i.EventTarget?i.EventTarget[a].dispatchEvent:{},d=[["Document."+a+".documentElement",i.Document[a],"documentElement"],["Element."+a+".shadowRoot",i.Element[a],"shadowRoot"],["Node."+a+".nodeType",i.Node[a],"nodeType"],["Object.is",i.Object,"is"],["Array."+a+".slice",i.Array[a],"slice"],["Document."+a+".querySelectorAll",i.Document[a],"querySelectorAll"],["Document."+a+".createElement",i.Document[a],"createElement"],["EventTarget."+a+".dispatchEvent",c,"dispatchEvent"]];return e.disableEvalPatching||d.push(["eval",i,"eval"]),d.forEach((function([e,s,o]){const a=Object.getOwnPropertyDescriptor(s,o),c=a&&(a.get||a.set);if(!a)return;if(c){if(!a.get)return}else if("object"!=typeof a.value&&"function"!=typeof a.value)return;const d=function(...n){const s={d:Date.now(),pnow:windowPerformanceNow(),n:e,st:(r.Error||i.Error)("FriendlyCaptcha_DummyTrace").stack||""};return t.push(s),(c?a.get:a.value).apply(this,n)};try{const e=c?a.get?a.get():void 0:a.value();e&&(d.length=e.length,d.name=e.name)}catch(e){}try{const e=mergeObject({},a);c?e.get=d:e.value=d,Object.defineProperty(s,o,e),n.set(d,c?a.get:a.value)}catch(e){}})),function(){return t.splice(0,t.length)}};function buildOnlineMetric(){const e=[0,0,0,0,0,0,0];return{s:e,add(t){const n=++e[0],i=t-e[1],r=i/n,s=r*r,o=i*r*(n-1);e[1]+=r,e[4]+=o*s*(n*n-3*n+3)+6*s*e[2]-4*r*e[3],e[3]+=o*r*(n-2)-3*r*e[2],e[2]+=o,1==n?e[5]=e[6]=t:(t<e[5]&&(e[5]=t),t>e[6]&&(e[6]=t))}}}var ssig,x="addEventListener",M=Math;function isAndroidUA(){return/Android/i.test(navigator.userAgent)}function onOffEventMetric(e,t,n=!1,i){const r=buildOnlineMetric();let s,o=!1;return runOnDocumentLoaded((()=>{(i=i||document.body)[x](e,(e=>{o&&!n||(s=e.timeStamp,o=!0)})),i[x](t,(e=>{o&&(r.add(e.timeStamp-s),o=!1)}))})),r.s}function eventCounts(e){const t=[];for(let n=0;n<e.length;n++)t.push(0),document[x](e[n],(e=>t[n]++));return t}function keyCountMetric(){const e=[0,0,0,0,0,0,0,0],t={8:1,46:1,9:2,45:3,17:4,13:5,37:6,38:6,39:6,40:6,33:7,34:7};return document[x]("keydown",(n=>{const i=n.keyCode;t[i]?e[t[i]]++:i>=112&&i<=123&&e[0]++})),e}function euclidean2d(e,t,n,i){return M.sqrt(M.pow(e-t,2)+M.pow(n-i,2))}function vector3Length(e,t,n){return M.sqrt(M.pow(e,2)+M.pow(t,2)+M.pow(n,2))}function deltaAngle(e,t){let n=t-e;return n+=n>180?-360:n<-180?360:0,n}var Signals=class{constructor(e){this.rn=0,this.i=0,this.smel={n:0,ts:0,d:0};const t="mouse",n=this.smel,i=e=>{n.n||(n.fts=e.timeStamp,n.fxy=[e.clientX,e.clientY,e.screenX,e.screenY]),n.n++,e.type===t+"leave"&&(n.d+=e.timeStamp-n.ts),n.ts=e.timeStamp,n.xy=[e.clientX,e.clientY]},r=document;runOnDocumentLoaded((()=>{const e=r.body;e[x](t+"enter",i),e[x](t+"leave",i)})),this.bh={onoff:{kdu:onOffEventMetric("keydown","keyup"),cse:onOffEventMetric("compositionstart","compositionend"),mdu:onOffEventMetric(t+"down",t+"up"),mle:onOffEventMetric(t+"leave",t+"enter"),med:onOffEventMetric(t+"enter",t+"down",!0),semd:onOffEventMetric("scrollend",t+"down",!0,r),se:onOffEventMetric("scroll","scrollend",!1,r),pdc:onOffEventMetric("pointerdown","pointercancel",!0),mmc:onOffEventMetric(t+"move","click",!0),tse:onOffEventMetric("touchstart","touchend"),fikd:onOffEventMetric("focusin","keydown",!0)},nev:eventCounts([t+"out","pointercancel","focus","focusin","blur","visibilitychange","copy","paste","cut","contextmenu","click","auxclick","wheel","resize"]),nk:keyCountMetric(),mov:this.setupMovementMetrics(),dm:this.setupMotionMetrics(),do:this.setupOrientationMetrics()},this.dep=e.disableEvalPatching||!1,this.takeTraceRecords=patchNativeFunctions(e)}setupMovementMetrics(){let e,t=[];const n=buildOnlineMetric(),i=buildOnlineMetric(),r=buildOnlineMetric(),s={t:n.s,v:r.s,d:i.s,ns:0},o=()=>{const o=t[t.length-1];if(t.length>=200||o&&(o[0]&&this.tm.timeStamp===o[1]||!o[0]&&this.mm.timeStamp===o[1])){if(clearInterval(e),e=void 0,1===t.length)return s.ns++,void(t=[]);const a=t[0];n.add(o[1]-a[1]),i.add(euclidean2d(o[2],a[2],o[3],a[3]));for(let e=1;e<t.length;e++){const n=t[e],i=t[e-1],s=1e3*euclidean2d(n[2],i[2],n[3],i[3]),o=n[1]-i[1];r.add(s/o)}return void(t=[])}let a=0;if(o?a=o[0]:this.mm&&this.tm?a=this.mm.timeStamp>this.tm.timeStamp?0:1:this.mm||(a=1),a){const e=this.tm.touches[0];e&&t.push([1,this.tm.timeStamp,e.screenX,e.screenY])}else t.push([0,this.mm.timeStamp,this.mm.screenX,this.mm.screenY])};let a=-1;return runOnDocumentLoaded((()=>{const t=document.body;t[x]("mousemove",(t=>{this.mm=t,void 0===e&&(o(),e=setInterval(o,50))})),t[x]("touchmove",(t=>{this.tm=t;const n=t.touches[0];if(n){const e=n.radiusX+1.234*n.radiusY;e!==a&&(a=e,this.rn++)}void 0===e&&(o(),e=setInterval(o,50))}))})),s}setupMotionMetrics(){const e=buildOnlineMetric(),t=buildOnlineMetric(),n={n:0,ts:0,ac:e.s,rr:t.s,i:0,g:!1};return isAndroidUA()?(window[x]("devicemotion",(i=>{n.ts=i.timeStamp,n.i=i.interval,n.g=!i.acceleration;const r=i.acceleration||i.accelerationIncludingGravity;r&&e.add(vector3Length(r.x,r.y,r.z));const s=i.rotationRate;s&&t.add(vector3Length(s.alpha,s.beta,s.gamma))})),n):n}setupOrientationMetrics(){const e=buildOnlineMetric(),t=buildOnlineMetric(),n={fts:0,ts:0,gd:e.s,bd:t.s};if(!isAndroidUA())return n;let i;return window[x]("deviceorientation",(r=>{null!=r.gamma&&null!=r.beta&&null!=r.alpha&&(n.ts=r.timeStamp,n.a=r.alpha,n.b=r.beta,n.g=r.gamma,i?(e.add(deltaAngle(r.gamma,n.g)),t.add(deltaAngle(n.b,r.beta))):(n.fts=n.ts,i=!0))})),n}gmm(){const e=this.mm;return e&&{xy:[e.clientX,e.clientY,e.screenX,e.screenY,e.offsetX,e.offsetY,e.pageX,e.pageY,e.movementX,e.movementY],ts:e.timeStamp}}gtm(){const e=this.tm,t=e&&e.touches,n=t&&t[0];return e&&n&&{id:n.identifier,xy:[n.clientX,n.clientY,n.screenX,n.screenY,n.pageX,n.pageY],r:[n.radiusX,n.radiusX,n.rotationAngle,n.force],n:t.length,ts:e.timeStamp,rn:this.rn}}get(e){const t=document.body,n=window,i=n.performance;return{v:1,i:++this.i,hl:history.length,fe:!!window.frameElement,dep:this.dep,wid:e,sc:parseInt(sessionCount(!1)),sid:sessionId(),conv:0,t:{pnow:windowPerformanceNow(),pto:i&&i.timeOrigin||0,ts:Date.now()},dims:{d:[n.innerWidth,n.innerHeight,n.outerWidth,n.outerHeight,n.screenX,n.screenY,n.pageXOffset,n.pageYOffset,t.clientWidth,t.clientHeight],dpr:n.devicePixelRatio},mel:this.smel,mm:this.gmm(),tm:this.gtm(),bh:this.bh,stack:(new Error).stack||"",trc:this.takeTraceRecords()}}};function getSignals(e){return ssig||(ssig=new Signals(e))}var SHORTHANDS={eu:"https://eu.frcapi.com",global:"https://global.frcapi.com"};function resolveAPIOrigin(e){let t=e;return t?SHORTHANDS[t]&&(t=SHORTHANDS[t]):t=SHORTHANDS.global,originOf(t)}function getSDKDisableEvalPatching(){const e=document.querySelector('meta[name="frc-disable-eval-patching"]');return!!e&&!!e.content}function getSDKAPIEndpoint(){const e=document.querySelector('meta[name="frc-api-endpoint"]');if(e)return e.content;const t=document.currentScript;if(t){const e=t.dataset.frcApiEndpoint;if(e)return e}const n=document.querySelector(".frc-captcha[data-api-endpoint]");if(n){const e=n.dataset.apiEndpoint;if(e)return e}}var cbus,agentEndpoint="/api/v2/captcha/agent",widgetEndpoint="/api/v2/captcha/widget",FRAME_ID_DATASET_FIELD2="FrcFrameId",IFRAME_EXP_TIME=1296e5,sdkC=0,FriendlyCaptchaSDK=class{constructor(e={}){if(this.agents=new Map,this.agentState=new Map,this.widgets=new Map,this._attached=flatPromise(),this.attached=this._attached.promise,this.apiEndpoint=e.apiEndpoint,(cbus=cbus||new CommunicationBus).listen((e=>this.onReceiveMessage(e))),this.bus=cbus,++sdkC>1&&console.warn("Multiple Friendly Captcha SDKs created, this is not recommended. Please use a single SDK instance."),this.signals=getSignals({disableEvalPatching:e.disableEvalPatching||getSDKDisableEvalPatching()}),e.startAgent){const e=resolveAPIOrigin(this.apiEndpoint||getSDKAPIEndpoint());this.ensureAgentIFrame(e)}this.setupPeriodicRefresh()}onReceiveMessage(e){if("root_set_response"===e.type){const t=this.widgets.get(e.widget_id);if(!t)return void(1===sdkC&&console.warn(`Received set response message for widget ${e.widget_id} that doesn't exist`));t.setState(e)}else if(stringHasPrefix(e.type,"root_store"))this.handleStoreMessage(e);else if("root_signals_get"===e.type)this.handleSignalsGetMessage(e);else if("widget_reset"===e.type){const t=this.widgets.get(e.from_id);if(!t)return void(1===sdkC&&console.warn(`Received reset message for widget ${e.from_id} that doesn't exist`));t.reset({trigger:"widget"})}}handleSignalsGetMessage(e){const t=this.signals.get(e.widget_id);this.bus.send({type:"root_signals_get_reply",from_id:"",to_id:e.from_id,_frc:1,rid:e.rid,value:t})}handleStoreMessage(e){const t=e.from_id,n=this.agentState.get(t);n?"root_store_get"===e.type?n.store.get(e.key,{p:e.p}).then((i=>{this.bus.send({type:"root_store_get_reply",from_id:"",to_id:t,_frc:1,rid:e.rid,value:i,sa:n.store.hasSA()})})):"root_store_set"===e.type&&n.store.set(e.key,e.value,{p:e.p}).then((()=>{this.bus.send({type:"root_store_set_reply",from_id:"",to_id:t,_frc:1,rid:e.rid,sa:n.store.hasSA()})})):console.error(`Store not found ${t}`)}ensureAgentIFrame(e){const t=e+agentEndpoint;let n=document.getElementsByClassName(AGENT_FRAME_CLASSNAME);for(let t=0;t<n.length;t++){const i=n[t];if(originOf(i.src)===e&&i.dataset[FRAME_ID_DATASET_FIELD2])return i.dataset[FRAME_ID_DATASET_FIELD2]}const i="a_"+randomId(12),r=createAgentIFrame(this,i,t);this.agents.set(e,r),this.agentState.set(i,{store:new Store(e),origin:e}),document.body.appendChild(r);let s=1;const o=()=>{this.bus.registerTargetIFrame("agent",i,r,this.getRetryTimeout(s)).then((t=>{if("timeout"===t){if(s>4)return console.error("[Friendly Captcha] Failed to load agent iframe after 4 retries."),r.remove(),void this.agents.delete(e);console.warn("[Friendly Captcha] Retrying agent iframe load."),r.src+="&retry="+s++,o()}}))};return o(),i}setupPeriodicRefresh(){let e=1;setInterval((()=>{const t="&expire="+e++;this.agents.forEach(((e,n)=>{e.src+=t})),this.widgets.forEach(((e,n)=>{e.getElement().querySelector("iframe").src+=t}))}),IFRAME_EXP_TIME)}getRetryTimeout(e){return 1e3*Math.pow(e,1.8)+2e3}attach(e){void 0===e&&(e=findCaptchaElements()),Array.isArray(e)||e instanceof NodeList||(e=[e]);const t=[];for(let n=0;n<e.length;n++){const i=e[n];if(i&&!i.frcWidget){const e=i.dataset,n={element:i,sitekey:e.sitekey,formFieldName:e.formFieldName,apiEndpoint:e.apiEndpoint,language:e.lang,theme:e.theme,startMode:e.start};t.push(this.createWidget(n))}}const n=this.getAllWidgets();return this._attached.resolve(n),this.attached=Promise.resolve(n),t}createWidget(e){const t=resolveAPIOrigin(e.apiEndpoint||this.apiEndpoint||getSDKAPIEndpoint());this.bus.addOrigin(t);const n=this.ensureAgentIFrame(t),i="w_"+randomId(12),r=e=>{const t={from_id:i,to_id:n,_frc:1};this.bus.send(mergeObject(t,e))},s={onDestroy:()=>{r({type:"root_destroy_widget"}),this.bus.removeTarget(i),this.widgets.delete(i),e.element.innerHTML="",removeWidgetRootStyles(e.element)},onReset:()=>{r({type:"root_reset_widget"})},onTrigger:e=>{r({type:"root_trigger_widget",trigger:e.trigger})}},o=flatPromise(),a=new WidgetHandle({id:i,createOpts:e,callbacks:s,registered:o.promise});this.widgets.set(i,a);const c=createWidgetIFrame(n,i,t+widgetEndpoint,e),d=createWidgetPlaceholder(e);setWidgetRootStyles(e.element),createBanner(e);const l=d.style;d.textContent="Anti-Robot check connecting...";let h=1;const g=()=>{this.bus.registerTargetIFrame("widget",i,c,this.getRetryTimeout(h)).then((t=>{if("timeout"===t){if(h>4)return console.error("[Friendly Captcha] Failed to load widget iframe after 4 retries."),a.setState({state:"error",response:".ERROR",error:{code:"network_error",detail:"Widget load timeout, stopped retrying"}}),l.borderColor="#f00",l.fontSize="12px",void(d.textContent=`Anti-Robot check failed to connect to page or ${originOf(c.src)}\nCheck your connection and try again.`);l.backgroundColor="#fee",l.color="#222",d.textContent=`Anti-Robot check took too long to connect.\n\nRetrying... (${h})`,console.warn(`[Friendly Captcha] Retrying widget ${i} iframe load.`),a.setState({state:"error",response:".ERROR",error:{code:"network_error",detail:"Widget load timeout, will retry."}}),c.src+="&retry="+h++,g()}else"registered"===t&&(e.element.removeChild(d),c.style.display="")}))};return g(),o.resolve(),a}getAllWidgets(){const e=[];return this.widgets.forEach((t=>{e.push(t)})),e}getWidgetById(e){return this.widgets.get(e)}clear(){this.widgets.forEach((e=>{e.destroy()})),this.agents.forEach((e=>{e.remove()})),this.agents.clear()}},FRCWidgetStateChangeEventName="frc:widget.statechange",FRCWidgetCompleteEventName="frc:widget.complete",FRCWidgetExpireEventName="frc:widget.expire",FRCWidgetErrorEventName="frc:widget.error",FRCWidgetResetEventName="frc:widget.reset";export{FRCWidgetCompleteEventName,FRCWidgetErrorEventName,FRCWidgetExpireEventName,FRCWidgetResetEventName,FRCWidgetStateChangeEventName,FriendlyCaptchaSDK};
/*!
 * Copyright (c) Friendly Captcha GmbH 2023.
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at https://mozilla.org/MPL/2.0/.
 */
